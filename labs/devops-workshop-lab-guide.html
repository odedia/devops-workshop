<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<meta name="keywords" content="DevOps, Spring Boot, Spring Cloud">
<meta name="author" content="Christopher Phillipson, Additional enhancements by Kobi Shamama and Oded Shopen">
<title>DevOps Workshop Lab Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article">
<div id="header">
<h1>DevOps Workshop Lab Guide</h1>
<div class="details">
<span id="author" class="author">Christopher Phillipson, Additional enhancements by Kobi Shamama and Oded Shopen</span><br>
<span id="email" class="email"><a href="mailto:cphillipson@pivotal.io">cphillipson@pivotal.io</a>, Additional enhancements by <a href="mailto:oshopen@pivotal.io">oshopen@pivotal.io</a> and <a href="mailto:kshamama@pivotal.io">kshamama@pivotal.io</a></span><br>
<span id="revnumber">version 3.0,</span>
<span id="revdate">2020-02-01</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction_labs_setup">Introduction: Labs Setup</a>
<ul class="sectlevel2">
<li><a href="#_overview">Overview</a></li>
<li><a href="#_pcf_environment_access">PCF Environment Access</a></li>
<li><a href="#_apps_manager_ui">Apps Manager UI</a></li>
</ul>
</li>
<li><a href="#_01_building_a_spring_boot_application">01. Building a Spring Boot Application</a>
<ul class="sectlevel2">
<li><a href="#_getting_started">Getting started</a></li>
<li><a href="#_add_an_endpoint">Add an Endpoint</a></li>
<li><a href="#_build_the_cloud_native_spring_application">Build the <em>cloud-native-spring</em> application</a></li>
<li><a href="#_run_the_cloud_native_spring_application">Run the <em>cloud-native-spring</em> application</a></li>
</ul>
</li>
<li><a href="#_02_enhancing_boot_application_with_metrics">02. Enhancing Boot Application with Metrics</a>
<ul class="sectlevel2">
<li><a href="#_set_up_the_actuator">Set up the Actuator</a></li>
<li><a href="#_include_version_control_info">Include Version Control Info</a></li>
<li><a href="#_health_indicators">Health Indicators</a></li>
<li><a href="#_metrics">Metrics</a></li>
</ul>
</li>
<li><a href="#_03_creating_a_dockerfile">03. Creating a Dockerfile</a></li>
<li><a href="#_04_deploying_to_kubernetes">04. Deploying to Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_creating_a_namespace">Creating a namespace</a></li>
<li><a href="#_creating_a_deployment">Creating a deployment</a></li>
<li><a href="#_creating_a_service">Creating a service</a></li>
<li><a href="#_exposing_a_dns_record">Exposing a DNS Record</a></li>
<li><a href="#_scaling">Scaling</a></li>
<li><a href="#_testing_our_results">Testing our results</a></li>
<li><a href="#_making_changes">Making changes</a></li>
<li><a href="#_logging">Logging</a></li>
<li><a href="#_monitoring">Monitoring</a></li>
<li><a href="#_the_bottom_line_if_you_got_all_of_the_requirements_above_working_well_congradulations_you_built_your_own_platform_on_top_of_kubernetes">The bottom line: If you got all of the requirements above working well, congradulations - you built your own platform on top of Kubernetes!</a></li>
</ul>
</li>
<li><a href="#_05_adding_persistence_to_our_boot_application">05. Adding Persistence to our Boot Application</a>
<ul class="sectlevel2">
<li><a href="#_create_a_hypermedia_driven_restful_web_service_with_spring_data_rest_using_jpa">Create a Hypermedia-Driven RESTful Web Service with Spring Data REST (using JPA)</a></li>
<li><a href="#_add_the_domain_object_city">Add the domain object - City</a></li>
<li><a href="#_use_flyway_to_manage_schema">Use Flyway to manage schema</a></li>
<li><a href="#_run_the_cloud_native_spring_application_2">Run the <em>cloud-native-spring</em> Application</a></li>
<li><a href="#_importing_data">Importing Data</a></li>
<li><a href="#_adding_search">Adding Search</a></li>
</ul>
</li>
<li><a href="#_06_running_with_persistence_in_docker">06. Running with persistence in Docker</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_the_database_docker_container">Setting up the database docker container</a></li>
<li><a href="#_setting_up_the_application">Setting up the application</a></li>
</ul>
</li>
<li><a href="#_07_running_with_persistence_in_kubernetes">07. Running with persistence in Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_source_of_database">Source of Database</a></li>
<li><a href="#_setting_up_a_database">Setting up a database</a></li>
<li><a href="#_the_bottom_line">The bottom line</a></li>
</ul>
</li>
<li><a href="#_08_introduction_to_cf_cli">08. Introduction to CF CLI</a>
<ul class="sectlevel2">
<li><a href="#_open_apps_manager">Open Apps Manager</a></li>
<li><a href="#_how_to_target_a_foundation_and_login">How to target a foundation and login</a></li>
<li><a href="#_how_to_deploy_an_application">How to deploy an application</a></li>
<li><a href="#_how_to_cleanup_after_yourself">How to cleanup after yourself</a></li>
<li><a href="#_where_to_go_for_more_help">Where to go for more help</a></li>
</ul>
</li>
<li><a href="#_09_deploy_app_with_persistence_to_pivotal_cloud_foundry">09. Deploy app with persistence to Pivotal Cloud Foundry</a>
<ul class="sectlevel2">
<li><a href="#_exploring_actuator_in_apps_manager">Exploring actuator in Apps Manager</a></li>
</ul>
</li>
<li><a href="#_10_adding_spring_cloud_config_to_boot_application">10. Adding Spring Cloud Config to Boot Application</a>
<ul class="sectlevel2">
<li><a href="#_update_hello_rest_service">Update <em>Hello</em> REST service</a></li>
<li><a href="#_run_the_cloud_native_spring_application_and_verify_dynamic_config_is_working">Run the <em>cloud-native-spring</em> Application and verify dynamic config is working</a></li>
<li><a href="#_create_spring_cloud_config_server_instance">Create Spring Cloud Config Server instance</a></li>
<li><a href="#_deploy_and_test_application">Deploy and test application</a></li>
</ul>
</li>
<li><a href="#_11_adding_service_registration_and_discovery_with_spring_cloud">11. Adding Service Registration and Discovery with Spring Cloud</a>
<ul class="sectlevel2">
<li><a href="#_update_cloud_native_spring_boot_application_to_register_with_eureka">Update <em>Cloud-Native-Spring</em> Boot Application to Register with Eureka</a></li>
<li><a href="#_create_spring_cloud_service_registry_instance_and_deploy_application">Create Spring Cloud Service Registry instance and deploy application</a></li>
<li><a href="#_deploy_and_test_application_2">Deploy and test application</a></li>
<li><a href="#_create_another_spring_boot_project_as_a_client_ui">Create another Spring Boot Project as a Client UI</a></li>
<li><a href="#_deploy_and_test_application_3">Deploy and test application</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<!-- toc disabled -->
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction_labs_setup">Introduction: Labs Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Welcome to the lab! Here you will find a collection of exercises and accompanying source-code.</p>
</div>
<div class="sect2">
<h3 id="_overview">Overview</h3>
<div class="paragraph">
<p>This workshop contains a number of lab folders meant to be worked through in numerical order - as each exercise builds upon the last. There is also a <em>samples</em> directory, containing completed applications that can be pushed to Cloud Foundry at any time.</p>
</div>
<div class="paragraph">
<p>Your workspace is the <strong>my_work</strong> folder. If you get stuck implementing any of the labs, <strong>solutions</strong> are available for your perusal.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pcf_environment_access">PCF Environment Access</h3>
<div class="paragraph">
<p>This workshop assumes participants will be interacting with PCF One.  Depending on the client and environment, ask the instuctor for an alternate CF API endpoint and/or url for the Apps Manager UI.</p>
</div>
<div class="sect3">
<h4 id="_account_set_up">Account set up</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you do not have an account yet, please ask the instructor for one.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_target_the_environment">Target the Environment</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you haven&#8217;t already, download the latest release of the Cloud Foundry CLI from <a href="https://github.com/cloudfoundry/cli/releases" class="bare">https://github.com/cloudfoundry/cli/releases</a> for your operating system and install it.</p>
</li>
<li>
<p>Set the API target for the CLI (set appropriate end point for your environment) and login:</p>
<div class="listingblock">
<div class="content">
<pre>$ cf api https://api.run.pcfone.io
$ cf login</pre>
</div>
</div>
<div class="paragraph">
<p>Enter your account username and password, then select an org and space.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_apps_manager_ui">Apps Manager UI</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>An alternative to installing the CF CLI is via your PCF Apps Manager interface.</p>
</li>
<li>
<p>Navigate in a web browser to (depending on environment):</p>
<div class="listingblock">
<div class="content">
<pre>https://apps.run.pcfone.io</pre>
</div>
</div>
</li>
<li>
<p>Login to the interface with your email and password</p>
<div class="paragraph">
<p>&#8594; The password will be supplied to you by the instructor</p>
</div>
</li>
<li>
<p>Click the 'Tools' link, and download the CLI matching your operating system</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_01_building_a_spring_boot_application">01. Building a Spring Boot Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab we&#8217;ll build a simple <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/">Spring Boot</a> application whose sole purpose is to reply with a standard greeting.</p>
</div>
<div class="sect2">
<h3 id="_getting_started">Getting started</h3>
<div class="paragraph">
<p>Although we will use a pre-created initial skeleton, it&#8217;s important you&#8217;ll learn how to use the <a href="https://start.spring.io">Spring Initializr</a>. Head over to the URL and enter the following details:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Select a Gradle Project (projects are usually built using gradle or maven)</p>
</li>
<li>
<p>Select Java and the target langauge.</p>
</li>
<li>
<p>Latest stable version</p>
</li>
<li>
<p><strong>group</strong>: io.pivotal</p>
</li>
<li>
<p><strong>artifact</strong>: cloud-native-spring</p>
</li>
<li>
<p>Search for the following dependencies:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Web</p>
</li>
<li>
<p>Hateoas</p>
</li>
<li>
<p>Rest Repositories</p>
</li>
<li>
<p>JPA</p>
</li>
<li>
<p>Actuator</p>
</li>
<li>
<p>Lombok</p>
</li>
</ol>
</div>
</li>
<li>
<p>Click "Generate"</p>
</li>
<li>
<p>Observe the contents of the downloaded ZIP file. This is the structure of a standard Spring Boot application. Code goes into <code>src/main/java</code>, properties or static content goes into <code>src/main/resources</code>, tests go into <code>src/test/java</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now let&#8217;s continue with the pre-made skeleton.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a Terminal (e.g., <em>cmd</em> or <em>bash</em> shell)</p>
</li>
<li>
<p>Clone the pre-existing git repository:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">git clone https://github.com/odedia/devops-workshop.git</code></pre>
</div>
</div>
</li>
<li>
<p>Change the working directory to be <code>devops-workshop/labs/my_work/cloud-native-spring</code></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd devops-workshop/labs/my_work/cloud-native-spring</code></pre>
</div>
</div>
</li>
<li>
<p>Open this project in your editor/IDE of choice (InteliJ is recommended).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">idea .</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_add_an_endpoint">Add an Endpoint</h3>
<div class="paragraph">
<p>Within your editor/IDE complete the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a new package <code>io.pivotal.controller</code> underneath <code>src/main/java</code>.</p>
</li>
<li>
<p>Create a new class named <code>GreetingController</code> in the aforementioned package.</p>
</li>
<li>
<p>Add an <code>@RestController</code> annotation to the class <code>io.pivotal.controller.GreetingController</code> (i.e., <code>/cloud-native-spring/src/main/java/io/pivotal/controller/GreetingController.java</code>).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.pivotal.controller;

import org.springframework.web.bind.annotation.RestController;

@RestController
public class GreetingController {

}</code></pre>
</div>
</div>
</li>
<li>
<p>Add the following request handler to the class <code>io.pivotal.controller.GreetingController</code> (i.e., <code>/cloud-native-spring/src/main/java/io/pivotal/controller/GreetingController.java</code>).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@GetMapping("/hello")
public String hello() {
    return "Hello World!";
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Completed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.pivotal.controller;

import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.GetMapping;

@RestController
public class GreetingController {

    @GetMapping("/hello")
    public String hello() {
        return "Hello World!";
    }

}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_build_the_cloud_native_spring_application">Build the <em>cloud-native-spring</em> application</h3>
<div class="paragraph">
<p>Return to the Terminal session you opened previously and make sure your working directory is set to be <code>devops-workshop/labs/my_work/cloud-native-spring</code></p>
</div>
<div class="paragraph">
<p>We&#8217;re going to use <a href="https://gradle.org">Gradle</a> to build and package artifacts. If you don&#8217;t already have gradle installed, don&#8217;t worry, we have you covered. You can use the embedded gradlew Wrapper.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Find out what tasks are available to you with</p>
<div class="literalblock">
<div class="content">
<pre>./gradlew tasks</pre>
</div>
</div>
</li>
<li>
<p>First we&#8217;ll run tests</p>
<div class="literalblock">
<div class="content">
<pre>./gradlew test</pre>
</div>
</div>
</li>
<li>
<p>Next we&#8217;ll package the application as a libary artifact (it cannot be run on its own)</p>
<div class="literalblock">
<div class="content">
<pre>./gradlew jar</pre>
</div>
</div>
</li>
<li>
<p>Next we&#8217;ll package the application as an executable artifact (that can be run on its own because it will include all transitive dependencies along with embedding a web server and a servlet container)</p>
<div class="literalblock">
<div class="content">
<pre>./gradlew build</pre>
</div>
</div>
</li>
<li>
<p>Examine the contents of the <code>build/libs</code> directory. You should see the final Spring Boot <em>jar</em> file. This jar file is completly portable - it contains everything that app needs, including an embedded Web server. This is why it is so big.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_cloud_native_spring_application">Run the <em>cloud-native-spring</em> application</h3>
<div class="paragraph">
<p>Now we&#8217;re ready to run the application</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the application with</p>
<div class="literalblock">
<div class="content">
<pre>./gradlew bootRun</pre>
</div>
</div>
</li>
<li>
<p>You should see the application start up an embedded Apache Tomcat server on port 8080 (review terminal output):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">2018-08-22 17:40:18.193  INFO 92704 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path ''
2018-08-22 17:40:18.199  INFO 92704 --- [           main] i.p.CloudNativeSpringUiApplication       : Started CloudNativeSpringUiApplication in 7.014 seconds (JVM running for 7.814)</code></pre>
</div>
</div>
</li>
<li>
<p>Browse to <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a></p>
</li>
<li>
<p>Stop the <em>cloud-native-spring</em> application. In the terminal window type <strong>Ctrl + C</strong></p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_02_enhancing_boot_application_with_metrics">02. Enhancing Boot Application with Metrics</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_set_up_the_actuator">Set up the Actuator</h3>
<div class="paragraph">
<p>Spring Boot includes a number of additional features to help you monitor and manage your application when it’s pushed to production. These features are added by adding <em>spring-boot-starter-actuator</em> to the classpath.  Our initial project setup already included it as a dependency.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Verify the Spring Boot Actuator dependency the in following file: <strong>cloud-native-spring/build.gradle</strong> You should see the following dependency in the list:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
    implementation('org.springframework.boot:spring-boot-starter-actuator')
    // other dependencies omitted
}</code></pre>
</div>
</div>
</li>
<li>
<p>Run the application again using <code>./gradlew bootRun</code> and then check the application&#8217;s metrics at <a href="http://localhost:8080/actuator" class="bare">http://localhost:8080/actuator</a>.</p>
</li>
<li>
<p>Stop the application by typing <strong>Ctrl+C</strong>.</p>
<div class="paragraph">
<p>By default Spring Boot does not expose all the management endpoints (which is a good thing!).  Though you wouldn&#8217;t want to expose all of them in production, we&#8217;ll do so in this sample app to make demonstration a bit easier and simpler.</p>
</div>
</li>
<li>
<p>Add the following properties to <strong>cloud-native-spring/src/main/resources/application.yml</strong>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">management:
  endpoints:
    web:
      exposure:
        include: "*"</code></pre>
</div>
</div>
</li>
<li>
<p>Run the updated application</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle clean bootRun</code></pre>
</div>
</div>
<div class="paragraph">
<p>Try out the following endpoints. The output is omitted here because it can be quite large:</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/health" class="bare">http://localhost:8080/actuator/health</a></p>
</div>
<div class="paragraph">
<p>&#8594; Displays Application and Datasource health information.  This can be customized based on application functionality, which we&#8217;ll do later.</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/beans" class="bare">http://localhost:8080/actuator/beans</a></p>
</div>
<div class="paragraph">
<p>&#8594; Displays all of the beans in the Spring context.</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/configprops" class="bare">http://localhost:8080/actuator/configprops</a></p>
</div>
<div class="paragraph">
<p>&#8594; Displays a collated list of all @ConfigurationProperties.</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/env" class="bare">http://localhost:8080/actuator/env</a></p>
</div>
<div class="paragraph">
<p>&#8594; Displays the application’s shell environment as well as all Java system properties.</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/mappings" class="bare">http://localhost:8080/actuator/mappings</a></p>
</div>
<div class="paragraph">
<p>&#8594; Displays all URI request mappings and the controller methods to which they are mapped.</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/threaddump" class="bare">http://localhost:8080/actuator/threaddump</a></p>
</div>
<div class="paragraph">
<p>&#8594; Displays a thread dump of the currently running application in JSON format.</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/heapdump" class="bare">http://localhost:8080/actuator/heapdump</a></p>
</div>
<div class="paragraph">
<p>&#8594; Downloads a heap dump that you can import into a JVM profiler such as JProfiler.</p>
</div>
<div class="paragraph">
<p>curl <a href="http://localhost:8080/actuator/httptrace" class="bare">http://localhost:8080/actuator/httptrace</a></p>
</div>
<div class="paragraph">
<p>&#8594; Displays trace information (by default the last few HTTP requests).</p>
</div>
</li>
<li>
<p>Stop the <em>cloud-native-spring</em> application.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_include_version_control_info">Include Version Control Info</h3>
<div class="paragraph">
<p>Spring Boot provides an endpoint (<a href="http://localhost:8080/actuator/info" class="bare">http://localhost:8080/actuator/info</a>) that allows the exposure of arbitrary metadata. By default, it is empty.</p>
</div>
<div class="paragraph">
<p>One thing that <em>actuator</em> does well is expose information about the specific build and version control coordinates for a given deployment.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the following file: <strong>cloud-native-spring/build.gradle</strong> Add the <a href="https://github.com/n0mer/gradle-git-properties">gradle-git-properties</a> plugin to your Gradle build.</p>
<div class="paragraph">
<p>First, you&#8217;ll need to be able to resolve the plugin so add the following to the <em>plugins{}</em> section</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">plugins {
    id 'com.gorylenko.gradle-git-properties' version '2.2.0'
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You&#8217;ll also configure the plugin by adding a <em>gitProperties{}</em> block.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">gitProperties {
    dateFormat = "yyyy-MM-dd'T'HH:mmZ"
    dateFormatTimeZone = "UTC"
    dotGitDirectory = "${project.rootDir}/../../.."
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; Note too that we are updating the path to the <em>.git</em> directory.</p>
</div>
<div class="paragraph">
<p>+
The effect of all this configuration is that the <em>gradle-git-properties</em> plugin adds Git branch and commit coordinates to the <strong>/actuator/info</strong> endpoint.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the <em>cloud-native-spring</em> application:</p>
<div class="literalblock">
<div class="content">
<pre>gradle clean bootRun</pre>
</div>
</div>
</li>
<li>
<p>Let&#8217;s verify that Git commit information is now included</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/actuator/info</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "git": {
        "commit": {
            "time": "2017-09-07T13:52+0000",
            "id": "3393f74"
        },
        "branch": "master"
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Stop the <em>cloud-native-spring</em> application</p>
<div class="paragraph">
<p><strong>What Just Happened?</strong></p>
</div>
<div class="paragraph">
<p>We have mapped Gradle properties into the <code>/actuator/info</code> endpoint.</p>
</div>
<div class="paragraph">
<p>Read more about exposing data in the <code>/actuator/info</code> endpoint <a href="https://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready">here</a></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_health_indicators">Health Indicators</h3>
<div class="paragraph">
<p>Spring Boot provides an endpoint <a href="http://localhost:8080/actuator/health" class="bare">http://localhost:8080/actuator/health</a> that exposes various health indicators that describe the health of the given application.</p>
</div>
<div class="paragraph">
<p>Normally, the <code>/actuator/health</code> endpoint will only expose an UP or DOWN value.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "status": "UP"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We want to expose more detail about the health and well-being of the application, so we&#8217;re going to need a bit more configuration to <code>cloud-native-spring/src/main/resources/application.yml</code>, underneath the <code>management</code> prefix, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">  endpoint:
    health:
      show-details: always</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the cloud-native-spring application:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle bootRun</code></pre>
</div>
</div>
</li>
<li>
<p>Use curl to verify the output of the health endpoint</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/actuator/health</code></pre>
</div>
</div>
<div class="paragraph">
<p>Out of the box is a <em>DiskSpaceHealthIndicator</em> that monitors health in terms of available disk space. Would your Ops team like to know if the app is close to running out of disk space? DiskSpaceHealthIndicator can be customized via <em>DiskSpaceHealthIndicatorProperties</em>. For instance, setting a different threshold for when to report the status as DOWN.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "status": "UP",
    "details": {
        "diskSpace": {
            "status": "UP",
            "details": {
                "total": 499963170816,
                "free": 375287070720,
                "threshold": 10485760
            }
        },
        "db": {
            "status": "UP",
            "details": {
                "database": "H2",
                "hello": 1
            }
        }
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Stop the cloud-native-spring application.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_metrics">Metrics</h3>
<div class="paragraph">
<p>Spring Boot provides an endpoint <a href="http://localhost:8080/actuator/metrics" class="bare">http://localhost:8080/actuator/metrics</a> that exposes several automatically collected metrics for your application. It also allows for the creation of custom metrics.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Browse to <a href="http://localhost:8080/actuator/metrics" class="bare">http://localhost:8080/actuator/metrics</a>. Review the metrics exposed.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "names": [
        "jvm.memory.max",
        "http.server.requests",
        "jdbc.connections.active",
        "process.files.max",
        "jvm.gc.memory.promoted",
        "tomcat.cache.hit",
        "system.load.average.1m",
        "tomcat.cache.access",
        "jvm.memory.used",
        "jvm.gc.max.data.size",
        "jdbc.connections.max",
        "jdbc.connections.min",
        "jvm.gc.pause",
        "jvm.memory.committed",
        "system.cpu.count",
        "logback.events",
        "tomcat.global.sent",
        "jvm.buffer.memory.used",
        "tomcat.sessions.created",
        "jvm.threads.daemon",
        "system.cpu.usage",
        "jvm.gc.memory.allocated",
        "tomcat.global.request.max",
        "hikaricp.connections.idle",
        "hikaricp.connections.pending",
        "tomcat.global.request",
        "tomcat.sessions.expired",
        "hikaricp.connections",
        "jvm.threads.live",
        "jvm.threads.peak",
        "tomcat.global.received",
        "hikaricp.connections.active",
        "hikaricp.connections.creation",
        "process.uptime",
        "tomcat.sessions.rejected",
        "process.cpu.usage",
        "tomcat.threads.config.max",
        "jvm.classes.loaded",
        "hikaricp.connections.max",
        "hikaricp.connections.min",
        "jvm.classes.unloaded",
        "tomcat.global.error",
        "tomcat.sessions.active.current",
        "tomcat.sessions.alive.max",
        "jvm.gc.live.data.size",
        "tomcat.servlet.request.max",
        "hikaricp.connections.usage",
        "tomcat.threads.current",
        "tomcat.servlet.request",
        "hikaricp.connections.timeout",
        "process.files.open",
        "jvm.buffer.count",
        "jvm.buffer.total.capacity",
        "tomcat.sessions.active.max",
        "hikaricp.connections.acquire",
        "tomcat.threads.busy",
        "process.start.time",
        "tomcat.servlet.error"
    ]
}</code></pre>
</div>
</div>
</li>
<li>
<p>Browse to <a href="http://localhost:8080/actuator/metrics/jvm.memory.used" class="bare">http://localhost:8080/actuator/metrics/jvm.memory.used</a> to see how much memory is currently being used.</p>
</li>
<li>
<p>Stop the cloud-native-spring application.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_03_creating_a_dockerfile">03. Creating a Dockerfile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that we have a running application, we want to run it in Kubernetes. But before we can do it, we&#8217;ll need to create a docker file (or, to be more precise: an <a href="https://www.opencontainers.org/">OCI-compliant</a> image).</p>
</div>
<div class="paragraph">
<p>For a simple demo application in this workshop, any choice is probably fine. However, when you go to production things get a big more complicated:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>What sould be our base operating system? There are many choices. Ubuntu, RedHat, Suse, CentOS.</p>
</li>
<li>
<p>Who will be in charge of patching the OS?</p>
</li>
<li>
<p>What version of Java should we use? There are <em>many</em> choices. Search <a href="https://hub.docker.com/search?q=java&amp;type=image">Docker hub</a> for Java and see the various options. Who performs CVE Patching on these images? (Hint: if you don&#8217;t know the answer, it&#8217;s probably you).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Write a Dockerfile for this app. Select one of the options from <a href="https://hub.docker.com/search?q=java&amp;type=image">Docker hub</a> for now.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The jar file containing the application is under <em>build/libs/cloud-native-spring-1.0-SNAPSHOT.jar</em>.</p>
</li>
<li>
<p>The command to run the java application is</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">java -jar &lt;file-name&gt;.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; Hint: Use the <code>ENTRYPOINT</code> command at the end of your Dockerfile to run the app.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s build the docker image:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker build -t cloud-native-spring .</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s run this container locally to make sure things still work.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -p 8080:8080 cloud-native-spring</code></pre>
</div>
</div>
<div class="paragraph">
<p>Go to <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and check the results.</p>
</div>
<div class="paragraph">
<p>Tag the image and push it to docker.io.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker tag cloud-native-spring &lt;your-username&gt;/cloud-native-spring
docker push &lt;your-username&gt;/cloud-native-spring</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div class="sect1">
<h2 id="_04_deploying_to_kubernetes">04. Deploying to Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab we&#8217;ll deploy our very simple application to Kubernetes, and try to make it production ready.</p>
</div>
<div class="paragraph">
<p>Login to PKS cluster shared by the instructor.</p>
</div>
<div class="sect2">
<h3 id="_creating_a_namespace">Creating a namespace</h3>
<div class="paragraph">
<p>Create a new namespace for your team:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl create namespace &lt;my-team&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_deployment">Creating a deployment</h3>
<div class="paragraph">
<p>Create a deployment manifest to run the image we just deployed. Here&#8217;s a skeleton you can use (or write your own):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: "1"
  labels:
    run:
  name:
  namespace: default
spec:
  replicas:
  selector:
    matchLabels:
      run:
  strategy:
    rollingUpdate:
      maxSurge:
      maxUnavailable:
    type:
  template:
    metadata:
      labels:
        run:
    spec:
      containers:
      - image:
        imagePullPolicy:
        name:
        ports:
        - containerPort:
          protocol:
      dnsPolicy:
      restartPolicy:</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_a_service">Creating a service</h3>
<div class="paragraph">
<p>Since we&#8217;re using PKS, we&#8217;re lucky - we can use a <code>LoadBalancer</code>. If we were to use another solution we might have to revert to a <code>NodePort</code> or to implement other solutions.
Complete the skeleton yaml below, or write your own:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">apiVersion: v1
kind: Service
metadata:
  labels:
    run:
  name:
  namespace:
spec:
  ports:
  - nodePort:
    port:
    protocol:
    targetPort:
  selector:
    run:
  sessionAffinity: None
  type:</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_exposing_a_dns_record">Exposing a DNS Record</h3>
<div class="paragraph">
<p>There are several ways to expose the service as a routable URL:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can create an A record pointing to the load balancer. You will have to make sure the IP doesn&#8217;t change.</p>
<div class="paragraph">
<p>&#8594; Problem: Developers rarely have access to DNS, which means waiting for tickets between development and IT.</p>
</div>
</li>
<li>
<p>You can create an ingress gateway that routes to the deployment, which requires installing an additional ingress service to the cluster such as nginx.</p>
</li>
<li>
<p>You can leverage Istio/KNative</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For now, let&#8217;s just use the External IP we got.</p>
</div>
</div>
<div class="sect2">
<h3 id="_scaling">Scaling</h3>
<div class="paragraph">
<p>Edit the deployment yaml so that there are 3 pods instead of 1.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_our_results">Testing our results</h3>
<div class="paragraph">
<p>Check your external IP by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl get svc -n &lt;my-team-namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Open <a href="http://&lt;my-external-ip&gt;/hello" class="bare">http://&lt;my-external-ip&gt;/hello</a> and make sure you got a response.</p>
</div>
</div>
<div class="sect2">
<h3 id="_making_changes">Making changes</h3>
<div class="paragraph">
<p>One of the main advantages of going cloud-native is to have a fast feedback loop.
What would happen if you were to make a single change in the code right now?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change the greeting message from "Hello World!" to "Hello VMware!".</p>
</li>
<li>
<p>Get your new code to a running state in Kubernetes.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_logging">Logging</h3>
<div class="paragraph">
<p>Check the logs of one of the pods by running <code>kubectl logs &lt;pod-name&gt; -n &lt;my-team-namespace&gt;</code>.</p>
</div>
<div class="paragraph">
<p>Logs from one pod is nice, but your application is being served from multiple pods.
How can you get the logs from all pods of your app?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can use sidecar containers to manually handle logging to a central solution</p>
</li>
<li>
<p>You can install Fluentd daemon sets (requires privilege access to <code>kube_system</code> namespace)</p>
</li>
<li>
<p>You can use commercial solutions such as Splunk, Datadog, SumoLogic, Log Insight etc. (at an added cost)</p>
</li>
<li>
<p>You can use open source solutions such as ELK, Graylog (but it is now your responsibility to maintain and upgrade this solution)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_monitoring">Monitoring</h3>
<div class="paragraph">
<p>Our container provides basic metric information. We can get some of the data by running:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">kubectl describe pod &lt;my-pod&gt; -n &lt;my-team-namespace&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>But this will only give us information on a specific pod. What about connections between pods or deployments?
How can we find our own metrics that we expose via actuator? We can query the <em>/actuator</em> URL but this will only give a response from <em>one</em> of the pods.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can use commercial solutions such as SysDig, Dynatrace, NewRelic, Wavefront (at an added cost)</p>
</li>
<li>
<p>You can use open source solutions such as Kibana, Prometheus, Grafana (but it is your responsibility to maintain and upgrade them)</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_the_bottom_line_if_you_got_all_of_the_requirements_above_working_well_congradulations_you_built_your_own_platform_on_top_of_kubernetes">The bottom line: If you got all of the requirements above working well, congradulations - you built your own platform on top of Kubernetes!</h3>
<div class="imageblock">
<div class="content">
<img src="images/k8s1.jpg" alt="k8s1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/k8s2.jpg" alt="k8s2">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="images/k8s3.jpg" alt="k8s3">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_05_adding_persistence_to_our_boot_application">05. Adding Persistence to our Boot Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab we&#8217;ll utilize Spring Boot, Spring Data, and Spring Data REST to create a fully-functional hypermedia-driven RESTful web service. Along the way we&#8217;ll take a brief look at <a href="https://flywaydb.org">Flyway</a> which can help us manage updates to database schema and data.</p>
</div>
<div class="sect2">
<h3 id="_create_a_hypermedia_driven_restful_web_service_with_spring_data_rest_using_jpa">Create a Hypermedia-Driven RESTful Web Service with Spring Data REST (using JPA)</h3>
<div class="paragraph">
<p>This application will allow us to create, read update and delete records in an <a href="http://www.h2database.com/html/quickstart.html">in-memory</a> relational repository. We&#8217;ll continue building upon the Spring Boot application we built out in Lab 1.  The first stereotype we will need is the domain model itself, which is <code>City</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_add_the_domain_object_city">Add the domain object - City</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the package <code>io.pivotal.domain</code> and in that package create the class <code>City</code>. Into that file you can paste the following source code, which represents cities based on postal codes, global coordinates, etc:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.pivotal.domain;

@Data
@Entity
@Table(name="city")
public class City implements Serializable {
    private static final long serialVersionUID = 1L;

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private long id;

    @Column(nullable = false)
    private String name;

    @Column(nullable = false)
    private String county;

    @Column(nullable = false)
    private String stateCode;

    @Column(nullable = false)
    private String postalCode;

    @Column
    private String latitude;

    @Column
    private String longitude;

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we&#8217;re using <a href="http://docs.oracle.com/javaee/6/tutorial/doc/bnbpz.html">JPA</a> annotations on the class and its fields. We&#8217;re also employing <a href="https://projectlombok.org/features/all">Lombok</a>, so we don&#8217;t have to write a bunch of boilerplate code (e.g., getter and setter methods).  You&#8217;ll need to use your IDE&#8217;s features to add the appropriate import statements.</p>
</div>
<div class="paragraph">
<p>&#8594; Hint: imports should start with <code>javax.persistence</code> and <code>lombok</code></p>
</div>
</li>
<li>
<p>Create the package <code>io.pivotal.repositories</code> and in that package create the interface <code>CityRepository</code>. Paste the following code and add appropriate imports:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.pivotal.repositories;

@RepositoryRestResource(collectionResourceRel = "cities", path = "cities")
public interface CityRepository extends PagingAndSortingRepository&lt;City, Long&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You’ll need to use your IDE’s features to add the appropriate import statements.</p>
</div>
<div class="paragraph">
<p>&#8594; Hint: imports should start with <code>org.springframework.data.rest.core.annotation</code> and <code>org.springframework.data.repository</code></p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_use_flyway_to_manage_schema">Use Flyway to manage schema</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit <em>build.gradle</em> and add the following dependencies within the <em>dependencies {}</em> block</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">implementation('org.flywaydb:flyway-core:5.2.4')
implementation('com.zaxxer:HikariCP:3.3.0')</code></pre>
</div>
</div>
</li>
<li>
<p>Create a new file named <code>V1_0__init_database.sql</code> underneath <em>devops-workshop/labs/my_work/cloud-native-spring/src/main/resources/db/migration</em>, add the following lines and save.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">CREATE TABLE city (
   ID INTEGER PRIMARY KEY AUTO_INCREMENT,
   NAME VARCHAR(100) NOT NULL,
   COUNTY VARCHAR(100) NOT NULL,
   STATE_CODE VARCHAR(10) NOT NULL,
   POSTAL_CODE VARCHAR(10) NOT NULL,
   LATITUDE VARCHAR(15) NOT NULL,
   LONGITUDE VARCHAR(15) NOT NULL
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Spring Boot comes with out-of-the-box <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-database-initialization.html#howto-execute-flyway-database-migrations-on-startup">integration</a> support for <a href="https://flywaydb.org/documentation/plugins/springboot">Flyway</a>.  When we start the application it will execute a versioned <a href="https://flywaydb.org/documentation/migrations#sql-based-migrations">SQL migration</a> that will create a new table in the database.</p>
</div>
</li>
<li>
<p>Add the following lines to <em>devops-workshop/labs/my_work/cloud-native-spring/src/main/resources/application.yml</em></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">spring:
  datasource:
    hikari:
      connection-timeout: 60000
      maximum-pool-size: 5</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/brettwooldridge/HikariCP/blob/dev/README.md">Hikari</a> is a database connection pool implementation. We are limiting the number of database connections an individual application instance may consume.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_cloud_native_spring_application_2">Run the <em>cloud-native-spring</em> Application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Return to the Terminal session you opened previously</p>
</li>
<li>
<p>Run the application</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle clean bootRun</code></pre>
</div>
</div>
</li>
<li>
<p>Access the application using <code>curl</code> or your web browser using the newly added REST repository endpoint at <a href="http://localhost:8080/cities" class="bare">http://localhost:8080/cities</a>. You&#8217;ll see that the primary endpoint automatically exposes the ability to page, size, and sort the response JSON.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/cities

HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
Content-Type: application/hal+json;charset=UTF-8
Transfer-Encoding: chunked
Date: Thu, 28 Apr 2016 14:44:06 GMT

{
  "_embedded" : {
    "cities" : [ ]
  },
  "_links" : {
    "self" : {
      "href" : "http://localhost:8080/cities"
    },
    "profile" : {
      "href" : "http://localhost:8080/profile/cities"
    }
  },
  "page" : {
    "size" : 20,
    "totalElements" : 0,
    "totalPages" : 0,
    "number" : 0
  }
}</code></pre>
</div>
</div>
</li>
<li>
<p>To exit the application, type <strong>Ctrl-C</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>So what have you done? Created four small classes, modified a build file, added some configuration and SQL migration scripts, resulting in a fully-functional REST microservice. The application&#8217;s <code>DataSource</code> is created automatically by Spring Boot using the in-memory database because <strong>no other <code>DataSource</code> was detected in the project</strong>.</p>
</div>
<div class="paragraph">
<p>Next we&#8217;ll import some data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_importing_data">Importing Data</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy the <a href="https://raw.githubusercontent.com/Pivotal-Field-Engineering/devops-workshop/master/labs/import.sql">import.sql</a> file found in <code>devops-workshop/labs/</code> to <code>devops-workshop/labs/my_work/cloud-native-spring/src/main/resources/db/migration</code>. Rename the file to be <code>V1_1__seed_data.sql</code>. (This is a small subset of a larger dataset containing all of the postal codes in the United States and its territories).</p>
</li>
<li>
<p>Restart the application.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle clean bootRun</code></pre>
</div>
</div>
</li>
<li>
<p>Access the application again. Notice the appropriate hypermedia is included for <code>next</code>, <code>previous</code>, and <code>self</code>. You can also select pages and page size by utilizing <code>?size=n&amp;page=n</code> on the URL string. Finally, you can sort the data utilizing <code>?sort=fieldName</code> (replace fieldName with a cities attribute).</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/cities

HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
X-Application-Context: application
Content-Type: application/hal+json
Transfer-Encoding: chunked
Date: Tue, 27 May 2014 19:59:58 GMT

{
  "_links" : {
    "next" : {
      "href" : "http://localhost:8080/cities?page=1&amp;size=20"
    },
    "self" : {
      "href" : "http://localhost:8080/cities{?page,size,sort}",
      "templated" : true
    }
  },
  "_embedded" : {
    "cities" : [ {
      "name" : "HOLTSVILLE",
      "county" : "SUFFOLK",
      "stateCode" : "NY",
      "postalCode" : "00501",
      "latitude" : "+40.922326",
      "longitude" : "-072.637078",
      "_links" : {
        "self" : {
          "href" : "http://localhost:8080/cities/1"
        }
      }
    },

    // ...

    {
      "name" : "CASTANER",
      "county" : "LARES",
      "stateCode" : "PR",
      "postalCode" : "00631",
      "latitude" : "+18.269187",
      "longitude" : "-066.864993",
      "_links" : {
        "self" : {
          "href" : "http://localhost:8080/cities/20"
        }
      }
    } ]
  },
  "page" : {
    "size" : 20,
    "totalElements" : 42741,
    "totalPages" : 2138,
    "number" : 0
  }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Try the following URL Paths with <code>curl</code> to see how the application behaves:</p>
<div class="paragraph">
<p><a href="http://localhost:8080/cities?size=5" class="bare">http://localhost:8080/cities?size=5</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cities?size=5&amp;page=3" class="bare">http://localhost:8080/cities?size=5&amp;page=3</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cities?sort=postalCode,desc" class="bare">http://localhost:8080/cities?sort=postalCode,desc</a></p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next we&#8217;ll add searching capabilities.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_search">Adding Search</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let&#8217;s add some additional finder methods to <code>CityRepository</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestResource(path = "name", rel = "name")
Page&lt;City&gt; findByNameIgnoreCase(@Param("q") String name, Pageable pageable);

@RestResource(path = "nameContains", rel = "nameContains")
Page&lt;City&gt; findByNameContainsIgnoreCase(@Param("q") String name, Pageable pageable);

@RestResource(path = "state", rel = "state")
Page&lt;City&gt; findByStateCodeIgnoreCase(@Param("q") String stateCode, Pageable pageable);

@RestResource(path = "postalCode", rel = "postalCode")
Page&lt;City&gt; findByPostalCode(@Param("q") String postalCode, Pageable pageable);

@Query(value ="select c from City c where c.stateCode = :stateCode")
Page&lt;City&gt; findByStateCode(@Param("stateCode") String stateCode, Pageable pageable);</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; Hint: imports should start with <code>org.springframework.data.domain</code>, <code>org.springframework.data.rest.core.annotation</code>, <code>org.springframework.data.repository.query</code>, and <code>org.springframework.data.jpa.repository</code></p>
</div>
</li>
<li>
<p>Run the application</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle clean bootRun</code></pre>
</div>
</div>
</li>
<li>
<p>Access the application again. Notice that hypermedia for a new <code>search</code> endpoint has appeared.</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/cities

HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
X-Application-Context: application
Content-Type: application/hal+json
Transfer-Encoding: chunked
Date: Tue, 27 May 2014 20:33:52 GMT

// prior omitted
    },
    "_links": {
        "first": {
            "href": "http://localhost:8080/cities?page=0&amp;size=20"
        },
        "self": {
            "href": "http://localhost:8080/cities{?page,size,sort}",
            "templated": true
        },
        "next": {
            "href": "http://localhost:8080/cities?page=1&amp;size=20"
        },
        "last": {
            "href": "http://localhost:8080/cities?page=2137&amp;size=20"
        },
        "profile": {
            "href": "http://localhost:8080/profile/cities"
        },
        "search": {
            "href": "http://localhost:8080/cities/search"
        }
    },
    "page": {
        "size": 20,
        "totalElements": 42741,
        "totalPages": 2138,
        "number": 0
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Access the new <code>search</code> endpoint:</p>
<div class="paragraph">
<p><a href="http://localhost:8080/cities/search" class="bare">http://localhost:8080/cities/search</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">curl http://localhost:8080/cities/search

HTTP/1.1 200 OK
Server: Apache-Coyote/1.1
X-Application-Context: application
Content-Type: application/hal+json
Transfer-Encoding: chunked
Date: Tue, 27 May 2014 20:38:32 GMT

{
    "_links": {
        "postalCode": {
            "href": "http://localhost:8080/cities/search/postalCode{?q,page,size,sort}",
            "templated": true
        },
        "state": {
            "href": "http://localhost:8080/cities/search/state{?q,page,size,sort}",
            "templated": true
        },
        "nameContains": {
            "href": "http://localhost:8080/cities/search/nameContains{?q,page,size,sort}",
            "templated": true
        },
        "name": {
            "href": "http://localhost:8080/cities/search/name{?q,page,size,sort}",
            "templated": true
        },
        "findByStateCode": {
            "href": "http://localhost:8080/cities/search/findByStateCode{?stateCode,page,size,sort}",
            "templated": true
        },
        "self": {
            "href": "http://localhost:8080/cities/search"
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we now have new search endpoints for each of the finders that we added.</p>
</div>
</li>
<li>
<p>Try a few of these endpoints in <a href="https://www.getpostman.com">Postman</a>. Feel free to substitute your own values for the parameters.</p>
<div class="paragraph">
<p><a href="http://localhost:8080/cities/search/postalCode?q=01229" class="bare">http://localhost:8080/cities/search/postalCode?q=01229</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cities/search/name?q=Springfield" class="bare">http://localhost:8080/cities/search/name?q=Springfield</a></p>
</div>
<div class="paragraph">
<p><a href="http://localhost:8080/cities/search/nameContains?q=West&amp;size=1" class="bare">http://localhost:8080/cities/search/nameContains?q=West&amp;size=1</a></p>
</div>
<div class="paragraph">
<p>&#8594; For further details on what&#8217;s possible with Spring Data JPA, consult the <a href="https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#dependencies.spring-boot">reference documentation</a></p>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_06_running_with_persistence_in_docker">06. Running with persistence in Docker</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we use the in-memory H2 database which is good for unit testing, but it&#8217;s not feasible for production use - all our data will be gone whenever we restart the application.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_the_database_docker_container">Setting up the database docker container</h3>
<div class="paragraph">
<p>First, we&#8217;ll need to run a database. We&#8217;ll use MySQL in our example. Searching Dockerhub, it seems that the default <em>mysql</em> image is the best option.</p>
</div>
<div class="paragraph">
<p>Before running the image, we need to setup a new docker network, so that our app container and our db container can talk to each other:</p>
</div>
<div class="paragraph">
<p><code>docker network create mynet</code></p>
</div>
<div class="paragraph">
<p>Now let&#8217;s run the database in docker:</p>
</div>
<div class="paragraph">
<p><code>docker run --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=my-secret-pw -d --net mynet mysql:5.7</code></p>
</div>
<div class="paragraph">
<p>The default user for this image is <code>root</code>. This is the first sign that the defaults are not production ready, because you&#8217;d rarely run your database as root. Also, the image would run the container but does not take into account responsibilities such as upgrading, backups, auditing etc. These are your responsiblity.</p>
</div>
<div class="paragraph">
<p>Also, the image doesn&#8217;t create any schemas other than the internal <code>sys</code> schema which we cannot use for our application. We&#8217;ll need to create a new schema first. Let&#8217;s ssh into our container:</p>
</div>
<div class="paragraph">
<p><code>docker exec -it mysql bash</code></p>
</div>
<div class="paragraph">
<p>Once in the container, we need to run the mysql cli (it would default to <em>localhost:3306</em> which is what we want):</p>
</div>
<div class="paragraph">
<p><code>mysql -p</code></p>
</div>
<div class="paragraph">
<p>Enter the password frmo above (<code>my-secret-pw</code>)</p>
</div>
<div class="paragraph">
<p>Now that we are in the cli, we can create our schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">mysql&gt; create schema my_db;
Query OK, 1 row affected (0.00 sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>type <code>exit</code> twice to return to the host.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_the_application">Setting up the application</h3>
<div class="paragraph">
<p>We now need to add the MySQL JDBC (Java Database Connectivity) driver to our application. Add the following to <code>build.gradle</code> under <code>dependencies</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">runtime('mysql:mysql-connector-java')</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now have two drivers in our application: H2 and MySQL. How will Spring know which database I want to use?</p>
</div>
<div class="paragraph">
<p>Like everything else in Spring, it uses <em>convention over configuration</em> and common sense. If you didn&#8217;t provide connection parameters to MySQL, it would fallback to H2 since that&#8217;s the default, testable database it can use.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now define the connection parameters for our MySQL database. Update the <code>spring:database</code> section in <code>application.yml</code> so it would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">spring:
  datasource:
    hikari:
      connection-timeout: 60000
      maximum-pool-size: 5
    url: jdbc:mysql://${MYSQL_HOST:localhost}:3306/my_db?useSSL=false
    username: root
    password: my-secret-pw</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can immediatly see another issue - our password is written in clear text in our configuration file. We can think of various ways to overcome this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using a Spring Cloud Config Server</p>
</li>
<li>
<p>Using environment variables when starting the server</p>
</li>
<li>
<p>Managing secrets when runing on Kubernetes (although remember - the default secret plugin is not encypted so it makes no difference!)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Compile the updated application:</p>
</div>
<div class="paragraph">
<p><code>./gradlew build</code></p>
</div>
<div class="paragraph">
<p>We can see another problem: our unit tests now use our "production" database, which is not desirable. Also, if our MySQL database is not running, our tests will fail. run <code>docker stop mysql</code> and try builing the application again - the tests would fail.</p>
</div>
<div class="paragraph">
<p>We&#8217;d like to keep using our H2 database for tests. We can do that by adding a different <code>application.yml</code> under <code>src/test/resources</code>. Anything that we&#8217;ll put in this file will <em>override</em> the default configuration onyl when tests are running.</p>
</div>
<div class="paragraph">
<p>Create the file <code>src/test/resources/application.yml</code> and populate the following for H2 Database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">spring:
  datasource:
    hikari:
      connection-timeout: 60000
      maximum-pool-size: 5
    driver-class-name: org.h2.Driver
    url: jdbc:h2:mem:db;DB_CLOSE_DELAY=-1
    username: sa
    password: sa</code></pre>
</div>
</div>
<div class="paragraph">
<p>Build the Docker image for our app again:</p>
</div>
<div class="paragraph">
<p><code>docker build -t &lt;my-id&gt;/cloud-native-spring .</code></p>
</div>
<div class="paragraph">
<p>And run it (notice the use of <code>--net</code> to allow us to communicate between two containers):</p>
</div>
<div class="paragraph">
<p><code>docker run -p 8080:8080 --net mynet -e MYSQL_HOST=mysql &lt;my-id&gt;/cloud-native-spring</code></p>
</div>
<div class="paragraph">
<p>&#8594; Interesting point: If you used a base OS called <code>openjdk</code>, its going to use Java 11. If your local machine&#8217;s JDK for compilation is JDK 8, the startup would fail. Make sure you have the correct pipeline of Java versions (or any other language for that matter).</p>
</div>
<div class="paragraph">
<p>See the log output to confirm you are connected to the new MySQL Database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">2020-02-02 12:24:01.154  INFO 7228 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Starting...
Sun Feb 02 12:24:01 IST 2020 WARN: Establishing SSL connection without server's identity verification is not recommended. According to MySQL 5.5.45+, 5.6.26+ and 5.7.6+ requirements SSL connection must be established by default if explicit option isn't set. For compliance with existing applications not using SSL the verifyServerCertificate property is set to 'false'. You need either to explicitly disable SSL by setting useSSL=false, or set useSSL=true and provide truststore for server certificate verification.
2020-02-02 12:24:01.704  INFO 7228 --- [           main] com.zaxxer.hikari.HikariDataSource       : HikariPool-1 - Start completed.
2020-02-02 12:24:01.707  INFO 7228 --- [           main] o.f.c.internal.database.DatabaseFactory  : Database: jdbc:mysql://localhost:3306/my_db (MySQL 8.0)
2020-02-02 12:24:03.028  INFO 7228 --- [           main] o.f.core.internal.command.DbValidate     : Successfully validated 2 migrations (execution time 00:01.269s)
2020-02-02 12:24:03.056  INFO 7228 --- [           main] o.f.core.internal.command.DbMigrate      : Current version of schema `my_db`: 1.0
2020-02-02 12:24:03.059  INFO 7228 --- [           main] o.f.core.internal.command.DbMigrate      : Migrating schema `my_db` to version 1.1 - seed data
2020-02-02 12:25:51.336  INFO 7228 --- [           main] o.f.core.internal.command.DbMigrate      : Successfully applied 1 migration to schema `my_db` (execution time 01:48.294s)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Verify you still get a response from <code>http://localhost:8080/cities</code>.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_07_running_with_persistence_in_kubernetes">07. Running with persistence in Kubernetes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_source_of_database">Source of Database</h3>
<div class="paragraph">
<p>How will we install our database in Kubernetes?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We can install a database directly as an image like we just did locally, but that would present issues for upgrades, monitoring etc.</p>
</li>
<li>
<p>We can use helm charts that wrap images with some recommended values and best practices. Who would be responsible for upgrading them?</p>
</li>
<li>
<p>We can purchase database solutions based on Kubernetes operators / CRDs from a well-known vendor. The amount of production ready solutions is still low (Confluent Kafka, Greenplum, MongoDB Enterprise).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Regardless of the solution, we need to think of the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We need to make sure that <em>only</em> our application can access the database and no other pods. This requires Kubernetes <em>network policies</em> to be in place.</p>
</li>
<li>
<p>We need to update our application to point to the new database URL, username and password.</p>
</li>
<li>
<p>We need to do this every time we move to other environments (such as other namespaces or Kubernetes clusters).</p>
</li>
<li>
<p>We need to store password in a well-encrypted store. The default kubernetes secret management uses base64 encoding <strong>which is not an encryption solution</strong></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_setting_up_a_database">Setting up a database</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>For the sake of speed, you&#8217;ll be preseted with the final Kubernetes yaml files. However, as you can image, defining all of the from scratch is not easy or trivial.</p>
</li>
<li>
<p>We need to setup a Persistent Volume (PV) to hold our stateful database files. For example:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv-volume
  labels:
    type: local
spec:
  storageClassName: standard
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: "/mnt/data"
  persistentVolumeReclaimPolicy: Delete</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We need to define a Persistent Volume Claim (PVC) that would provision such PVs for us:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
spec:
  storageClassName: standard
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We need to define a network policy that would only allow access from specific pods with specific labels:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>kind: NetworkPolicy
apiVersion: networking.k8s.io/v1
metadata:
  name: db-allow
spec:
  podSelector:
    matchLabels:
      app: mysql
  ingress:
  - from:
      - podSelector:
          matchLabels:
            type: backend-app</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Finally, we can define a deployment yaml for our database. Note that we use the password as a clear-text environment variable here. For real production use, we should have used a Kubernetes secret backed by a real encryption store such as Vault.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
spec:
  selector:
    matchLabels:
      app: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - image: mysql:5.7
        name: mysql
        env:
          # Use secret in real usage
        - name: MYSQL_ROOT_PASSWORD
          value: my-secret-pw
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pv-claim</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We also need to define a Kubernetes service to expose our database. Since we only have one pod running, we can define <code>clusterIP</code> as <code>None</code> for better performance.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  ports:
  - port: 3306
  selector:
    app: mysql
  clusterIP: None</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We&#8217;ll also need to update our application&#8217;s deployment yaml to override the MYSQL_HOST from the default set in <code>application.yml</code> to the service in our namespace:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>        env:
          # Use secret in real usage
        - name: MYSQL_HOST
          value: mysql.default.svc.cluster.local #replace default with your actual namespace name!</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Here&#8217;s the full application deployment.yml for reference:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  labels:
    run: cloud-native-spring
    type: backend-app
  name: cloud-native-spring
  #namespace: instructor
spec:
  replicas: 1
  selector:
    matchLabels:
      run: cloud-native-spring
  strategy:
    rollingUpdate:
    type: RollingUpdate
  template:
    metadata:
      labels:
        run: cloud-native-spring
        type: backend-app
    spec:
      containers:
      - image: odedia/cloud-native-spring
        env:
          # Use secret in real usage
        - name: MYSQL_HOST
          value: mysql.default.svc.cluster.local
        imagePullPolicy: Always
        name: cloud-native-spring
        ports:
        - containerPort: 8080
          protocol: TCP</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Some considerations for "code smells": Our application&#8217;s deployment yaml is not portable, since it hardcodes the value of the target MySQL host. It&#8217;s better to define a ConfigMap or another Kubernetes component to manage the value. Also, the password for the database is set both in our <code>application.yml</code> and in the database&#8217;s deployment yaml file. We&#8217;re also still using <code>latest</code> as the version of our application, which is not a good idea. It&#8217;s better to manage real versions in our docker registry and update the deployment yaml every time to the newer version. For now, our best option is to delete the delpoymenta and run <code>kubectl apply</code> again.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Check the value of the EXTERNAL IP for the service <code>cloud-native-spring</code>. Open the URL and check if you can see data in <code>https://&lt;external-ip&gt;/cities</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_the_bottom_line">The bottom line</h3>
<div class="paragraph">
<p>Congradulations! We were able to deploy a very simple app with a database to Kubernetes! However, as we saw along the way, getting something to work and getting something to be production ready are two different things.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We haven&#8217;t configured an external DNS, and are only using an external IP address.</p>
</li>
<li>
<p>Our docker image is not optimized. Every build pushes+pulls the entire 70+mb jar file layer.</p>
</li>
<li>
<p>Our start command is simple and works, but not optimized or tuned with the many JVM options.</p>
</li>
<li>
<p>We don&#8217;t have aggregated logging, advanced monitoring solution, management UI or any of the items discussed in the previous Kubernetes exercise.</p>
</li>
<li>
<p>Our database exposes the password and does not handle auditing, upgrades, migrations etc.</p>
</li>
<li>
<p>We have <strong>a lot</strong> of yaml files to manage. We need to configure <em>everything</em>, there are no assumptions or conventions for our deployments.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>If you got all of the requirements above working in a production-ready manner, congradulations - you built your own platform on top of Kubernetes</strong>!</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/k8s1.jpg" alt="k8s1" width="500">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/k8s2.jpg" alt="k8s2" width="500">
</div>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/k8s3.jpg" alt="k8s3" width="500">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_08_introduction_to_cf_cli">08. Introduction to CF CLI</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far we discussed Java, but Cloud Foundry supports all the modern, cloud-native languages. Let&#8217;s deploy some simple sample apps in various languages.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the working directory to be <em>devops-workshop/labs/samples</em></p>
<div class="paragraph">
<p>Note the sub-directories present..</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">samples
├── dotnet-core-sample
├── go-sample
├── nodejs-sample
├── python-sample</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; If you want to be able to deploy these samples you must have <em>Go</em>, <em>Node</em>, <em>.Net Core</em>, and <em>Python</em> installed.</p>
</div>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_open_apps_manager">Open Apps Manager</h3>
<div class="paragraph">
<p>Go to the URL <a href="https://apps.run.pcfone.io" class="bare">https://apps.run.pcfone.io</a> and login with the credentials provided by your instructor.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_target_a_foundation_and_login">How to target a foundation and login</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a Terminal (e.g., <em>cmd</em> or <em>bash</em> shell)</p>
</li>
<li>
<p>Target a foundation and login</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cf login -a https://api.run.pcfone.io</pre>
</div>
</div>
<div class="paragraph">
<p>+
Enter your account username and password, then select an org and space unless those were chosen for you automatically.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_deploy_an_application">How to deploy an application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let&#8217;s take a look at the CF CLI options</p>
<div class="literalblock">
<div class="content">
<pre>cf help -a</pre>
</div>
</div>
</li>
<li>
<p>Let&#8217;s see what buildpacks are available to us</p>
<div class="literalblock">
<div class="content">
<pre>cf buildpacks</pre>
</div>
</div>
</li>
<li>
<p>Peruse the services you can provision and bind your applications to</p>
<div class="literalblock">
<div class="content">
<pre>cf marketplace</pre>
</div>
</div>
</li>
<li>
<p>Time to deploy an app. How about Node.js? Before running <em>cf push</em>, always inspect the <em>manifest.yml</em> file in each directory.</p>
<div class="literalblock">
<div class="content">
<pre>cd nodejs-sample
cf push -c "node server.js"</pre>
</div>
</div>
<div class="paragraph">
<p>Notice that PCF also <em>built</em> the application for you before creating the container and running the app. You can also build your application locally (if you have <code>yarn</code> installed), and just provide the final artifact to PCF:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">yarn config set yarn-offline-mirror ./npm-packages-offline-cache
cp ~/.yarnrc .
rm -rf node_modules/ yarn.lock
yarn install

cf push -c "node server.js"</code></pre>
</div>
</div>
</li>
<li>
<p>Next, let&#8217;s try deploying a Python app. Note that again, PCF builds the application for you:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd ../python-sample
cf push my_pyapp</code></pre>
</div>
</div>
</li>
<li>
<p>Rinse and repeat for .Net Core (again, built during deployment):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd ../dotnet-core-sample
cf push</code></pre>
</div>
</div>
</li>
<li>
<p>Now let&#8217;s push a Go app. Notice there&#8217;s no <em>manifest.yml</em> in this directory. How did PCF know it&#8217;s a Go app?</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cd ../go-sample
cf push awesome-go-app -m 64M --random-route</code></pre>
</div>
</div>
</li>
<li>
<p>Check what applications have been deployed so far</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">  cf apps</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; Take some time to visit each of the applications you&#8217;ve just deployed.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Open Apps Manager and review your applications from the UI:</p>
</div>
<div class="paragraph">
<p><a href="https://apps.run.pcfone.io" class="bare">https://apps.run.pcfone.io</a></p>
</div>
<div class="paragraph">
<p>Click the "View App" link on the top right side of each app&#8217;s overview screen.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Let&#8217;s scale an app</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf scale cf-nodejs -i 3
cf apps</code></pre>
</div>
</div>
<div class="paragraph">
<p>Refresh the App&#8217;s URL and see how <em>INSTANCE INDEX</em> changes with each refresh.</p>
</div>
</li>
<li>
<p>Let&#8217;s stop an app, then check that it has indeed been stopped</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf stop cf-nodejs
cf apps</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_cleanup_after_yourself">How to cleanup after yourself</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Finally, let&#8217;s delete an app</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">  cf delete cf-nodejs</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; Repeat <code>cf delete</code> for each app you deployed.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_where_to_go_for_more_help">Where to go for more help</h3>
<div class="paragraph">
<p>&#8594; <a href="https://docs.cloudfoundry.org/cf-cli/getting-started.html">Getting Started with the CF CLI</a></p>
</div>
<div class="paragraph">
<p>&#8594; <a href="http://www.appservgrid.com/refcards/refcards/dzonerefcards/rc207-010d-cloud-foundry.pdf">Cloud Foundry Cheat Sheet</a></p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_09_deploy_app_with_persistence_to_pivotal_cloud_foundry">09. Deploy app with persistence to Pivotal Cloud Foundry</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ve built and run the application locally.
We deployed our application to Kubernetes.
Now we&#8217;ll deploy it to Cloud Foundry.
Our application needs to use a MySQL database. How will we deploy one to PCF? Simple, we&#8217;ll use the marketplace:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the following command to review the various services availble in the marketplace:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf marketplace</code></pre>
</div>
</div>
</li>
<li>
<p>Review the various plans that are available for the <code>mysql</code> service:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf marketplace -s p.mysql</code></pre>
</div>
</div>
</li>
<li>
<p>Let&#8217;s create a small MySQL Database:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf create-service p.mysql db-small my-database</code></pre>
</div>
</div>
</li>
<li>
<p>Our database is being created. You can check its status by running:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf service my-database</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; All of these can also be done directly from the Apps Manager GUI. Go to the Marketplace link on the left-hand side.
&#8594; Who was responsible for creating this database? It the operations team, not the development team. They added the service from the Pivotal Marketplace. The MySQL service in this case is a supported service from Pivotal. It also handles upgrades, backups, self-healing, monitoring with Healthwatch, auditing, and many other tasks that are not immediatly obvious.</p>
</div>
</li>
<li>
<p>Create an application manifest in the root folder <em>devops-workshop/labs/my_work/cloud-native-spring</em>
<code>touch manifest.yml</code></p>
</li>
<li>
<p>Add application metadata, using a text editor (of choice)</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">---
applications:
- name: cloud-native-spring
  random-route: true
  path: ./build/libs/cloud-native-spring-1.0-SNAPSHOT.jar
  services:
  - my-database</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above manifest entries will work with Java Buildpack 4.x series and JDK 8.  If you built the app with JDK 11 and want to deploy it you will need to make an additional entry in your manifest, just under <code>buildpacks</code>, add an environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">  env:
    JBP_CONFIG_OPEN_JDK_JRE: '{ jre: { version: 11.+ } }'</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; Notice the simplifed configuration file? We reduced 133 lines in Kubernetes to just 5 lines in PCF.</p>
</div>
<div class="paragraph">
<p>&#8594; Notice the service in the <code>manifest.yml</code>? It&#8217;s the service we just created. <strong>That&#8217;s all you need to do to make the connection between the application and the service</strong>. Remember how much work that required in Kubernetes?</p>
</div>
</li>
<li>
<p>Push application into Cloud Foundry</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf push</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; To specify an alternate manifest and buildpack, you could run something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf push -f my-other-manifest.yml -b java_buildpack</code></pre>
</div>
</div>
</li>
<li>
<p>Check the <code>start command</code> at the end of the log deployment:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">JAVA_OPTS="-agentpath:$PWD/.java-buildpack/open_jdk_jre/bin/jvmkill-1.16.0_RELEASE=printHeapHistogram=1 -Djava.io.tmpdir=$TMPDIR -XX:ActiveProcessorCount=$(nproc)
  -Djava.ext.dirs=$PWD/.java-buildpack/container_security_provider:$PWD/.java-buildpack/open_jdk_jre/lib/ext
  -Djava.security.properties=$PWD/.java-buildpack/java_security/java.security $JAVA_OPTS" &amp;&amp;
  CALCULATED_MEMORY=$($PWD/.java-buildpack/open_jdk_jre/bin/java-buildpack-memory-calculator-3.13.0_RELEASE -totMemory=$MEMORY_LIMIT -loadedClasses=16787
   -poolType=metaspace -stackThreads=250 -vmOptions="$JAVA_OPTS") &amp;&amp; echo JVM Memory Configuration: $CALCULATED_MEMORY &amp;&amp; JAVA_OPTS="$JAVA_OPTS $CALCULATED_MEMORY" &amp;&amp;
   MALLOC_ARENA_MAX=2 SERVER_PORT=$PORT eval exec $PWD/.java-buildpack/open_jdk_jre/bin/java $JAVA_OPTS -cp $PWD/. org.springframework.boot.loader.JarLauncher</code></pre>
</div>
</div>
</li>
<li>
<p>The reason for this long start command is that PCF optimizes the container and the JVM for production use. That includes running a memory calculator as part of the deployment to understand the optimal memory settings for the JVM, along with other fine-tuning. As you recall, our start command in the Dockerfile was simply <code>java -jar app.jar</code>. Notice how many things need to be taken into consideration when you need to be production ready!</p>
</li>
<li>
<p>Find the URL created for your app in the health status report. Browse to your app&#8217;s <code>/hello</code> endpoint.</p>
</li>
<li>
<p>Check the log output</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf logs cloud-native-spring --recent</code></pre>
</div>
</div>
</li>
<li>
<p>Check the <code>/cities</code> endpoint by going to <code>https://&lt;your-specific-route&gt;/cities</code>.
Wait a minute! How did this even work?! We didn&#8217;t update the properties under <code>src/main/resources/application.yml</code>, yet somehow our app created the <code>city</code> table and populated it on startup using flyway. Not only that - we didn&#8217;t even need to create a schema manually! How is that possible? That&#8217;s the power of the Open Service Broker API (OSBAPI).</p>
</li>
<li>
<p>To fully understand this magic, run the following command:
<code>cf env cloud-native-spring</code></p>
</li>
<li>
<p>Notice the <code>p.mysql</code> entry under <code>VCAP_SERVICES</code>? That was injected when we told our application that we&#8217;d like to <strong>bind</strong> our app to the <code>my-database</code> service. Binding provides all the environment variables needed to connect to the database (or any other service, such as a message broker). Even more impressive - Spring (and .NET with Steeltoe) knows how to autoconfigure itself and bind to this new database auto-magically. The parameters injected by the platform will override the settings in your <code>application.yml</code>, so your code will always remain portable. Eventially you&#8217;ll move to a production environment and bind to a different database instance called <code>my-database</code>, but that&#8217;s ok - all the parameters would be injected again, no code changes or recompile is required.</p>
</li>
<li>
<p>Perhaps even more important - you no longer have passwords scattered all over your code and your environment. <strong>Only</strong> users that are authoried to access this particular space and app will have the option to view the parameters of the database that includes the password. You can also leverage a PCF service called <em>Credhub</em>, which is an encrypted database for properties. If you were to use Credhub, you wouldn&#8217;t even see the parameters when running <code>cf env</code>. <strong>Only</strong> the application&#8217;s PID process would be able to automatically fetch the parameters on container startup.</p>
</li>
<li>
<p>How fast would it be to change one line in our code and have it running in "production"? Let&#8217;s change <code>GreetingController.java</code> to greet us with <code>Hello VMware on PCF!</code>. All that&#8217;s left to do is:</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>./gradlew build &amp;&amp; cf push</code></p>
</div>
<div class="paragraph">
<p>Check the updated results under <code>https://&lt;your-specific-route&gt;/hello</code></p>
</div>
<div class="sect2">
<h3 id="_exploring_actuator_in_apps_manager">Exploring actuator in Apps Manager</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>When running a Spring Boot (or .NET with Steeltoe) application on Pivotal Cloud Foundry with the actuator endpoints enabled, you can visualize actuator management information in the Apps Manager dashboard.</p>
</li>
<li>
<p>Visit the route created for your app and append /actuator/health to see the health status report. See the same details in the Apps Manager UI:</p>
<div class="imageblock">
<div class="content">
<img src="images/appsman.jpg" alt="appsman">
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Logs tab provides an <strong>aggregated</strong> view of all logs from all instances on our application. You can also change the logging level per class/package at runtime without having to restart:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/logging.png" alt="logging">
</div>
</div>
<div class="paragraph">
<p>The Trace tab shows you the recent REST API calls made to your application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/trace.png" alt="trace">
</div>
</div>
<div class="paragraph">
<p>The Threads tab provides visibility into all threads currently running in your JVM. You can also download a heap dump for offline investigation:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/threads.png" alt="threads">
</div>
</div>
<div class="paragraph">
<p>From the overview screen, clicking on PCF Metrics takes you to a full-blown monitoring dashboard where you can correlate system events along with the logs that happened at that time. Excellent for troubleshooting.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/pcf-metrics.png" alt="pcf metrics">
</div>
</div>
<div class="paragraph">
<p><strong>Congratulations!</strong> You’ve just deployed a full-blown application to PCF along with a supporting database!</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_10_adding_spring_cloud_config_to_boot_application">10. Adding Spring Cloud Config to Boot Application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab we&#8217;ll utilize Spring Boot and Spring Cloud to configure our application from a configuration dynamically retrieved from a Git repository. We&#8217;ll then deploy it to Pivotal Cloud Foundry and auto-provision an instance of a configuration server using Pivotal Spring Cloud Services.</p>
</div>
<div class="sect2">
<h3 id="_update_hello_rest_service">Update <em>Hello</em> REST service</h3>
<div class="paragraph">
<p>These features are added by adding <em>spring-cloud-services-starter-config-client</em> to the classpath.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Delete your exisiting Gradle build file, found here: <strong>/cloud-native-spring/build.gradle</strong>.  We&#8217;re going to make a few changes. Create a new <strong>/cloud-native-spring/build.gradle</strong> then cut-and-paste the content below into it and save.</p>
<div class="paragraph">
<p>Adding a dependency management plugin and other miscellaneous configuration.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">plugins {
    id 'com.gorylenko.gradle-git-properties' version '2.0.0'
    id 'org.springframework.boot' version '2.0.9.RELEASE'
    id 'io.spring.dependency-management' version '1.0.7.RELEASE'
    id 'java'
}

gitProperties {
    dateFormat = "yyyy-MM-dd'T'HH:mmZ"
    dateFormatTimeZone = "UTC"
    dotGitDirectory = "${project.rootDir}/../../.."
}

import org.apache.tools.ant.filters.*

processResources {
    filter ReplaceTokens, tokens: [
	    "application.name": project.property("application.name"),
	    "application.description": project.property("application.description"),
        "application.version": project.property("version")
    ]
}

dependencyManagement {
    imports {
        mavenBom org.springframework.boot.gradle.plugin.SpringBootPlugin.BOM_COORDINATES
        mavenBom "org.springframework.cloud:spring-cloud-dependencies:Finchley.SR3"
        mavenBom "io.pivotal.spring.cloud:spring-cloud-services-dependencies:2.0.3.RELEASE"
    }
}

dependencies {
    implementation('org.glassfish.jaxb:jaxb-runtime:2.4.0-b180830.0438')
    if (JavaVersion.current() != JavaVersion.VERSION_1_8) {
        implementation('org.javassist:javassist:3.23.0-GA')
    } else {
        implementation('org.javassist:javassist:3.22.0-GA')
    }
    annotationProcessor('org.projectlombok:lombok:1.18.6')
    implementation('org.projectlombok:lombok:1.18.6')
    implementation('org.springframework.boot:spring-boot-starter-actuator')
    implementation('org.springframework.boot:spring-boot-starter-data-jpa')
    implementation('org.springframework.boot:spring-boot-starter-data-rest')
    implementation('org.springframework.boot:spring-boot-starter-hateoas')
    implementation('org.springframework.data:spring-data-rest-hal-browser')
    implementation('org.springframework.boot:spring-boot-starter-web')
    implementation('org.springframework.boot:spring-boot-starter-security')
    implementation('io.pivotal.spring.cloud:spring-cloud-services-starter-config-client')
    implementation('org.flywaydb:flyway-core:5.2.4')
    implementation('com.zaxxer:HikariCP:3.3.0')
    runtime('com.h2database:h2')
    runtime('mysql:mysql-connector-java:8.0.15')
    testImplementation('org.springframework.boot:spring-boot-starter-test')
}

repositories {
    maven { url "https://repo.spring.io/plugins-release" }
    mavenCentral()
}

bootRun {
    // support passing -Dsystem.property=value to bootRun task
    systemProperties = System.properties
}

tasks.withType(Test) {
    if (JavaVersion.current() != JavaVersion.VERSION_1_8) {
        jvmArgs += ["--add-opens", "java.base/java.lang=ALL-UNNAMED"]
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Add an <em>@Value</em> annotation, private field, and update the existing <em>@GetMapping</em> annotated method to employ it in <em>io.pivotal.controller.GreetingController</em> (/cloud-native-spring/src/main/java/io/pivotal/controller/GreetingController.java):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Value("${greeting:Hola}")
    private String greeting;

    @GetMapping("/hello")
    public String hello() {
        return String.join(" ", greeting, "World!");
    }</code></pre>
</div>
</div>
</li>
<li>
<p>Add a <a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-commons/2.1.0.RELEASE/single/spring-cloud-commons.html#refresh-scope">@RefreshScope</a> annotation to the top of the <em>GreetingController</em> class declaration</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RefreshScope
@RestController
public class GreetingController {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Completed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.pivotal.controller;

import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;

@RefreshScope
@RestController
public class GreetingController {

    @Value("${greeting:Hola}")
    private String greeting;

    @GetMapping("/hello")
    public String hello() {
        return String.join(" ", greeting, "World!");
    }

}</code></pre>
</div>
</div>
</li>
<li>
<p>When we introduced the Spring Cloud Services Starter Config Client dependency Spring Security will also be included at runtime (Config servers will be protected by OAuth2).  However, this will also enable basic authentication to all our service endpoints.  We will need to add the following to conditionally open security (to ease local workstation deployment).</p>
<div class="paragraph">
<p>In <strong>build.gradle</strong>, we&#8217;ll need to add an <em>implementation</em> dependency</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">implementation('org.springframework.security:spring-security-config')</code></pre>
</div>
</div>
<div class="paragraph">
<p>In <strong>/cloud-native-spring/src/main/java/io/pivotal/CloudNativeSpringApplication.java</strong> right underneath the <code>public static void main</code> method implementation, add</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Configuration
	static class ApplicationSecurityOverride extends WebSecurityConfigurerAdapter {

    	@Override
    	public void configure(HttpSecurity http) throws Exception {
			http.csrf().disable();
            http.authorizeRequests().antMatchers("/**").permitAll();
    	}
	}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine this <a href="https://docs.spring.io/spring-boot/docs/2.1.3.RELEASE/reference/htmlsingle/#boot-features-security-mvc">Spring Boot reference</a> for further details. We&#8217;re going to disable cross-site request forgery.  We are also explicitly deactivating security, allowing unauthorized requests to all endpoints.</p>
</div>
</li>
<li>
<p>We&#8217;ll also want to give our Spring Boot App a name so that it can lookup application-specific configuration from the config server later.  Add the following configuration to <strong>/cloud-native-spring/src/main/resources/bootstrap.yml</strong>. (You&#8217;ll need to create this file.)</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">spring:
  application:
    name: cloud-native-spring</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_cloud_native_spring_application_and_verify_dynamic_config_is_working">Run the <em>cloud-native-spring</em> Application and verify dynamic config is working</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Run the application</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle clean bootRun</code></pre>
</div>
</div>
</li>
<li>
<p>Browse to <a href="http://localhost:8080/hello" class="bare">http://localhost:8080/hello</a> and verify you now see your new greeting.</p>
</li>
<li>
<p>Stop the <em>cloud-native-spring</em> application</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_spring_cloud_config_server_instance">Create Spring Cloud Config Server instance</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Now that our application is ready to read its config from a Cloud Config server, we need to deploy one!  This can be done through Cloud Foundry using the services Marketplace.  Browse to the Marketplace in Pivotal Cloud Foundry Apps Manager, navigate to the Space you have been using to push your app, and select Config Server:</p>
<div class="imageblock">
<div class="content">
<img src="images/config-scs.jpg" alt="config scs">
</div>
</div>
</li>
<li>
<p>In the resulting details page, select the <em>trial</em>, single tenant plan.  Name the instance <strong>config-server</strong>, select the Space that you&#8217;ve been using to push all your applications.  At this time you don&#8217;t need to select an application to bind to the service:</p>
<div class="imageblock">
<div class="content">
<img src="images/config-scs1.jpg" alt="config scs1">
</div>
</div>
</li>
<li>
<p>After we create the service instance you&#8217;ll be redirected to your <em>Space</em> landing page that lists your apps and services.  The config server is deployed on-demand and will take a few moments to deploy.  Once the messsage <em>The Service Instance is Initializing</em> disappears click on the service you provisioned.  Select the Manage link towards the top of the resulting screen to view the instance id and a JSON document with a single element, count, which validates that the instance provisioned correctly:</p>
<div class="imageblock">
<div class="content">
<img src="images/config-scs2.jpg" alt="config scs2">
</div>
</div>
</li>
<li>
<p>We now need to update the service instance with our GIT repository information.</p>
<div class="paragraph">
<p>Create a file named <code>config-server.json</code> and update its contents to be</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "git": {
    "uri": "https://github.com/pacphi/config-repo"
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: If you choose to replace the value of <code>"uri"</code> above with another Git repository that you have commit privileges to, you should make a copy of the <code>cloud-native-spring.yml</code> file. Then, as you update configuration in that file, you can test a POST request to the <code>cloud-native-spring</code> application&#8217;s <code>/refresh</code> end-point to see the new configuration take effect without restarting the application!</p>
</div>
<div class="paragraph">
<p>Using the Cloud Foundry CLI execute the following update service command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf update-service config-server -c config-server.json</code></pre>
</div>
</div>
</li>
<li>
<p>Refresh you Config Server management page and you will see the following message.  Wait until the screen refreshes and the service is reintialized:</p>
<div class="imageblock">
<div class="content">
<img src="images/config-scs3.jpg" alt="config scs3">
</div>
</div>
</li>
<li>
<p>We will now bind our application to our config-server within our Cloud Foundry deployment manifest.  Add these entries to the bottom of <strong>/cloud-native-spring/manifest.yml</strong></p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">  services:
  - config-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Complete:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">---
applications:
- name: cloud-native-spring
  host: cloud-native-spring-${random-word}
  memory: 1024M
  instances: 1
  path: ./target/cloud-native-spring-1.0-SNAPSHOT.jar
  buildpacks:
  - java_buildpack_offline
  stack: cflinuxfs3
  timeout: 180
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
  services:
  - config-server</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_and_test_application">Deploy and test application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the application</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle clean build</code></pre>
</div>
</div>
</li>
<li>
<p>Push application into Cloud Foundry</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf push</code></pre>
</div>
</div>
</li>
<li>
<p>Test your application by navigating to the /hello endpoint of the application.  You should now see a greeting that is read from the Cloud Config Server!</p>
<div class="paragraph">
<p>Ohai World!</p>
</div>
<div class="paragraph">
<p><strong>What just happened??</strong></p>
</div>
<div class="paragraph">
<p>&#8594; A Spring component within the Spring Cloud Starter Config Client module called a <em>service connector</em> automatically detected that there was a Cloud Config service bound into the application.  The service connector configured the application automatically to connect to the Cloud Config Server and downloaded the configuration and wired it into the application</p>
</div>
</li>
<li>
<p>If you navigate to the Git repo we specified for our configuration, <a href="https://github.com/pacphi/config-repo" class="bare">https://github.com/pacphi/config-repo</a>, you&#8217;ll see a file named <em>cloud-native-spring.yml</em>.  This filename is the same as our <em>spring.application.name</em> value for our Boot application.  The configuration is read from this file, in our case the following property:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">greeting: Ohai</code></pre>
</div>
</div>
</li>
<li>
<p>Next we&#8217;ll learn how to register our service with a Service Registry and load balance requests using Spring Cloud components.</p>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_11_adding_service_registration_and_discovery_with_spring_cloud">11. Adding Service Registration and Discovery with Spring Cloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this lab we&#8217;ll utilize Spring Boot and Spring Cloud to configure our application register itself with a Service Registry.  To do this we&#8217;ll also need to provision an instance of a Eureka service registry using Pivotal Cloud Foundry Spring Cloud Services.  We&#8217;ll also add a simple client application that looks up our application from the service registry and makes requests to our Cities service.</p>
</div>
<div class="sect2">
<h3 id="_update_cloud_native_spring_boot_application_to_register_with_eureka">Update <em>Cloud-Native-Spring</em> Boot Application to Register with Eureka</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>These features are added by adding <em>spring-cloud-services-starter-service-registry</em> to the classpath. Open your Gradle build file, found here: <strong>/cloud-native-spring/build.gradle</strong>. Add the following spring cloud services dependency:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
	// add this dependency
	implementation('io.pivotal.spring.cloud:spring-cloud-services-starter-service-registry')
}</code></pre>
</div>
</div>
</li>
<li>
<p>Thanks to Spring Cloud instructing your application to register with Eureka is as simple as adding a single annotation to your app! Add an <em>@EnableDiscoveryClient</em> annotation to the class <em>io.pivotal.CloudNativeSpringApplication</em> (/cloud-native-spring/src/main/java/io/pivotal/CloudNativeApplication.java):</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@EnableDiscoveryClient
public class CloudNativeSpringApplication {</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_spring_cloud_service_registry_instance_and_deploy_application">Create Spring Cloud Service Registry instance and deploy application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Now that our application is ready to registr with an Eureka instance, we need to deploy one!  This can be done through Cloud Foundry using the services Marketplace.  Previously we did this through the Marketplace UI. This time around we will use the Cloud Foundry CLI:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ cf create-service p-service-registry trial service-registry</code></pre>
</div>
</div>
</li>
<li>
<p>After you create the service registry instance navigate to your Cloud Foundry space in the Apps Manager UI and refresh the page.  You should now see the newly create Service Registry intance.  Select the Manage link to view the registry dashboard.  Note that there are not any registered applications at the moment:</p>
<div class="imageblock">
<div class="content">
<img src="images/registry1.jpg" alt="registry1">
</div>
</div>
</li>
<li>
<p>We will now bind our application to our service-registry within our Cloud Foundry deployment manifest.  Add an additional reference to the service at the bottom of <strong>/cloud-native-spring/manifest.yml</strong> in the services list:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">  services:
  - config-server
  - service-registry</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_and_test_application_2">Deploy and test application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the application</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle build</code></pre>
</div>
</div>
</li>
<li>
<p>Push application into Cloud Foundry</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf push</code></pre>
</div>
</div>
</li>
<li>
<p>If we now test our application URLs we will notice no significatnt changes.  However, if we view the Service Registry dashboard (accessible from the <em>Manage</em> link in Apps Manager) you will see that a service named cloud-native-spring has registered:</p>
<div class="imageblock">
<div class="content">
<img src="images/registry2.jpg" alt="registry2">
</div>
</div>
</li>
<li>
<p>Next we&#8217;ll create a simple UI application that will read from the Service Registry to discover the location of our cities REST service and connect.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_create_another_spring_boot_project_as_a_client_ui">Create another Spring Boot Project as a Client UI</h3>
<div class="paragraph">
<p>As in Lab 1 we will start with a project that has most of what we need to get going.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a Terminal (e.g., <em>cmd</em> or <em>bash</em> shell)</p>
</li>
<li>
<p>Change the working directory to be <em>devops-workshop/labs/my_work/cloud-native-spring-ui</em></p>
<div class="literalblock">
<div class="content">
<pre>cd /devops-workshop/labs/my_work/cloud-native-spring-ui</pre>
</div>
</div>
</li>
<li>
<p>Open this project in your editor/IDE of choice.</p>
<div class="paragraph">
<p><strong><em>STS Import Help</em></strong></p>
</div>
<div class="paragraph">
<p>Select <em>File &gt; Import…</em>. In the susequent dialog choose <em>Gradle &gt; Existing Gradle Project</em> then click the <em>Next</em> button. In the <em>Import Gradle Project</em> dialog browse to the <em>cloud-native-spring</em> directory (e.g. <em>devops-workshop/labs/my_work/cloud-native-spring-ui</em>) then click the <em>Open</em> button, then click the <em>Finish</em> button.</p>
</div>
</li>
<li>
<p>As before, we need to add <em>spring-cloud-services-starter-service-registry</em> and some collaborating dependencies to the classpath.  Add this to your <em>build.gradle</em>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">dependencies {
	 // add these dependencies
	 implementation('io.pivotal.spring.cloud:spring-cloud-services-starter-service-registry')
   implementation('org.springframework.cloud:spring-cloud-starter-openfeign')
   implementation('org.springframework.cloud:spring-cloud-starter-netflix-ribbon')
   implementation('org.hibernate:hibernate-core:5.4.1.Final')
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, we&#8217;re going to add some annotations to enable service discovery and hypermedia support.  In addition, we&#8217;re going to embed configuration and implementation for handling marshalling/unmarshalling of <a href="http://stateless.co/hal_specification.html">hal+json</a>.
Finally, we&#8217;ll override security behavior just as we did in  <code>cloud-native-spring</code>, adding exceptions for static resources provided by Vaadin.</p>
</div>
<div class="paragraph">
<p>Open <strong>cloud-native-spring-ui/src/main/java/io/pivotal/CloudNativeSpringUiApplication.java</strong> for editing and make sure the contents look like so</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients
@EnableHypermediaSupport(type = EnableHypermediaSupport.HypermediaType.HAL)
public class CloudNativeSpringUiApplication {

    public static void main(String[] args) {
        SpringApplication.run(CloudNativeSpringUiApplication.class, args);
    }

    @Configuration
    static class ClientConfig implements WebMvcConfigurer {

        @Autowired
        private HalHttpMessageConverter halHttpMessageConverter;

        @Override
        public void configureMessageConverters(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters) {
            converters.add(halHttpMessageConverter);
        }
    }

	@Configuration
	static class ApplicationSecurityOverride extends WebSecurityConfigurerAdapter {

    @Override
    public void configure(HttpSecurity web) throws Exception {
      web.csrf().disable();
      web.authorizeRequests().antMatchers("/**").permitAll();
    }

		@Override
    	public void configure(WebSecurity web) throws Exception {
			  web.ignoring().antMatchers(
          // Vaadin Flow static resources
          "/VAADIN/**",

          // the standard favicon URI
          "/favicon.ico",

          // the robots exclusion standard
          "/robots.txt",

          // web application manifest
          "/manifest.webmanifest",
          "/sw.js",
          "/offline-page.html",

          // (development mode) static resources
          "/frontend/**",

          // (development mode) webjars
          "/webjars/**",

          // (production mode) static resources
          "/frontend-es5/**", "/frontend-es6/**");
    	}
	}

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Don&#8217;t forget to adjust the imports!</p>
</div>
</li>
<li>
<p>Since this UI is going to consume REST services it&#8217;s an awesome opportunity to use Feign.  Feign will handle <strong>ALL</strong> the work of invoking our services and marshalling/unmarshalling JSON into domain objects.  We&#8217;ll add a Feign Client interface into our app.  Take note of how Feign references the downstream service; it&#8217;s only the name of the service it will lookup from Eureka Service Registry.  Create a new interface that resides in the same package as <em>CloudNativeSpringUiApplication</em>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.pivotal;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.hateoas.Resources;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;

import io.pivotal.domain.City;

@FeignClient(name = "https://cloud-native-spring")
public interface CityClient {

  @GetMapping(value = "/cities")
  Resources&lt;City&gt; findAll(@RequestParam("page") int page, @RequestParam("size") int limit);

  @PostMapping(value = "/cities")
  City add(@RequestBody City company);

  @PutMapping(value = "/cities/{id}")
  City update(@PathVariable("id") Long id, @RequestBody City city);

  @DeleteMapping(value = "/cities/{id}")
  void delete(@PathVariable("id") Long id);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Next we&#8217;ll create a <a href="https://vaadin.com/docs/flow/Overview.html">Vaadin Flow</a> UI for rendering our data.  The point of this workshop isn&#8217;t to go into detail on creating UIs; for now suffice to say that Vaadin is a great tool for quickly creating User Interfaces.  Our UI will consume our Feign client we just created.  Create the class <em>io.pivotal.AppUi</em> (/cloud-native-spring-ui/src/main/java/io/pivotal/AppUi.java) and into it paste the following code:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.pivotal;

import java.util.Collection;
import java.util.Collections;

import javax.annotation.PostConstruct;

import com.vaadin.flow.component.html.H2;
import com.vaadin.flow.component.orderedlayout.VerticalLayout;
import com.vaadin.flow.router.Route;
import com.vaadin.flow.server.PWA;
import com.vaadin.flow.theme.Theme;
import com.vaadin.flow.theme.material.Material;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.hateoas.Resources;
import org.vaadin.crudui.crud.impl.GridCrud;

import io.pivotal.domain.City;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Route(value = "")
@Theme(Material.class)
@PWA(name = "Cities UI, Vaadin Flow with Spring", shortName = "Cities UI")
public class CitiesUI extends VerticalLayout {

    private static final long serialVersionUID = 1L;

    private final CityClient client;
    private final GridCrud&lt;City&gt; crud;

    @Autowired
    public CitiesUI(CityClient client) {
        this.client = client;
        this.crud = new GridCrud&lt;&gt;(City.class);
    }

    @PostConstruct
    protected void init() {
        H2 title = new H2("Cities");
        crud.getGrid().setColumns("id", "name", "county", "stateCode", "postalCode", "latitude", "longitude");
        crud.getCrudFormFactory().setVisibleProperties("name", "county", "stateCode", "postalCode", "latitude", "longitude");
        crud.getCrudFormFactory().setUseBeanValidation(true);
        crud.setFindAllOperation(this::getCities);
        crud.setAddOperation(this::addCity);
        crud.setUpdateOperation(this::updateCity);
        crud.setDeleteOperation(this::deleteCity);
        add(title, crud);
        setSizeFull();
    }

    private Collection&lt;City&gt; getCities() {
        Resources&lt;City&gt; resources = client.findAll(0, 500);
        Collection&lt;City&gt; cities = Collections.emptyList();
        if (resources != null) {
            log.trace(resources.toString());
            cities = resources.getContent();
            log.debug("Fetched {} cities.", cities.size());
            if (!cities.isEmpty()) {
                crud.getGrid().setHeightByRows(true);
            }
        }
        return cities;
    }

    private City addCity(City city) {
        log.trace("City to be added is {}", city.toString());
        return client.add(city);
    }

    private City updateCity(City city) {
        log.trace("City to be updated is {}", city.toString());
        return client.update(city.getId(), city);
    }

    private void deleteCity(City city) {
        log.trace("City to be deleted", city.toString());
        client.delete(city.getId());
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>We&#8217;ll also want to give our UI App a name so that it can register properly with Eureka and potentially use cloud config in the future.  Add the following configuration to <strong>/cloud-native-spring-ui/src/main/resources/bootstrap.yml</strong>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yml" data-lang="yml">spring:
  application:
    name: cloud-native-spring-ui</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_deploy_and_test_application_3">Deploy and test application</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Build the application.  We have to skip the tests otherwise we may fail because of having 2 spring boot apps on the classpath</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">gradle build -x test</code></pre>
</div>
</div>
<div class="paragraph">
<p>&#8594; Note that we&#8217;re skipping tests here (because we now have a dependency on a running instance of <em>cloud-native-spring</em>).</p>
</div>
</li>
<li>
<p>Create an application manifest in the root folder /cloud-native-spring-ui</p>
<div class="paragraph">
<p>$ touch manifest.yml</p>
</div>
</li>
<li>
<p>Add application metadata</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">---
applications:
- name: cloud-native-spring-ui
  memory: 1024M
  random-route: true
  instances: 1
  path: ./build/libs/cloud-native-spring-ui-1.0-SNAPSHOT.jar
  buildpacks:
  - java_buildpack_offline
  stack: cflinuxfs3
  timeout: 180 # to give time for the data to import
  env:
    JAVA_OPTS: -Djava.security.egd=file:///dev/urandom
  services:
  - service-registry</code></pre>
</div>
</div>
</li>
<li>
<p>Push application into Cloud Foundry</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf push</code></pre>
</div>
</div>
</li>
<li>
<p>Test your application by navigating to the <code>/</code> endpoint, which will invoke the Vaadin UI.  You should now see a table listing the first set of rows returned from the cities microservice:</p>
<div class="imageblock">
<div class="content">
<img src="images/ui.jpg" alt="ui">
</div>
</div>
</li>
<li>
<p>From a commandline stop the cloud-native-spring microservice (the original City service, not the new UI)</p>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cf stop cloud-native-spring</code></pre>
</div>
</div>
</li>
<li>
<p>Refresh the UI app.</p>
<div class="paragraph">
<p><strong>What happens?</strong></p>
</div>
<div class="paragraph">
<p>Now you get a nasty error that is not very user friendly!</p>
</div>
<div class="paragraph">
<p>&#8594; Next we&#8217;ll learn how to make our UI Application more resilient in the case that our downstream services are unavailable.</p>
</div>
</li>
</ol>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 3.0<br>
Last updated 2020-02-01 14:28:55 +0200
</div>
</div>
</body>
</html>